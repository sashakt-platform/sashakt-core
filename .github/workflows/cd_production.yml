name: Deploy to Production tag

# Trigger only when a tag matching v* is pushed (eg v1.2.3)
on:
  push:
    tags:
      - 'v*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout (for logs)
        uses: actions/checkout@v4

      - name: Deploy via SSH (tag-based)
        uses: appleboy/ssh-action@v0.1.8
        env:
          # Expose runner values to the action container
          GITHUB_REF: ${{ github.ref }}
          # If you plan to support manual dispatch later, you can map inputs there too:
          INPUT_TAG: ${{ github.event.inputs.tag || '' }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: GITHUB_REF,INPUT_TAG 
          
          script: |
            cd /home/ubuntu
            cd sashakt-core-test

            set -euxo pipefail
            INPUT_TAG="${INPUT_TAG:-}"      # Populate this from actions input (see YAML) if provided
            GITHUB_REF="${GITHUB_REF:-}"    # safe default to empty string if not set

            echo "INPUT_TAG='${INPUT_TAG}'"
            echo "GITHUB_REF='${GITHUB_REF}'"

            if [[ -n "$INPUT_TAG" ]]; then
              TAG_NAME="$INPUT_TAG"
              echo "Using tag from INPUT_TAG: $TAG_NAME"
            elif [[ "$GITHUB_REF" == refs/tags/* ]]; then
              TAG_NAME="${GITHUB_REF#refs/tags/}"
              echo "Detected tag from GITHUB_REF: $TAG_NAME"
            else
              echo "ERROR: No tag provided. Either run the workflow with a tag or provide INPUT_TAG." >&2
              exit 1
            fi
            
            # Ensure git repo is clean and has tags
            git fetch --prune --tags origin

            # Checkout the exact tag (force to ensure clean working tree)
            git checkout -f "tags/${TAG_NAME}"

            # If you want to set to a detached branch (optional)
            # git checkout -B "deploy-${TAG_NAME}" "tags/${TAG_NAME}"
            echo "Deployment of tag ${TAG_NAME} completed."
